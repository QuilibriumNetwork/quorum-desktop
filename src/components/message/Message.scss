@use '@/styles/variables' as *;

@keyframes flash-highlight {
  0% {
    background-color: rgb(var(--warning) / 0.2);
  }
  50% {
    background-color: rgb(var(--warning) / 0.2); /* stay solid for 4s */
  }
  100% {
    background-color: transparent;
  }
}

.message-highlighted {
  animation: flash-highlight 8s ease-out;
}

/* Mention-specific highlight with longer duration and more subtle background */
@keyframes flash-highlight-mention {
  0% {
    background-color: rgb(var(--warning) / 0.1);
  }
  93.4% {
    background-color: rgb(var(--warning) / 0.1); /* stay solid for 57s */
  }
  100% {
    background-color: transparent; /* fade over 4s */
  }
}

.message-highlighted-mention {
  animation: flash-highlight-mention 61s ease-out;
}

/* === RESPONSIVE YOUTUBE EMBEDS === */
.youtube-embed {
  width: 100%;
  max-width: 560px;
  height: auto;
  aspect-ratio: 16 / 9;
  margin-top: $s-2;
  margin-bottom: $s-2;

  /* Prevent re-rendering issues */
  will-change: auto;
  transform: translateZ(0); /* Force hardware acceleration for smooth scrolling */

  /* Stable positioning to prevent layout shift */
  position: relative;
  contain: layout style paint;

  /* Below 1024px: enforce max-width to prevent full-width videos */
  @media (max-width: 1023px) {
    max-width: min(
      560px,
      calc(100vw - 120px)
    ) !important; /* Account for sidebar + padding */
  }

  /* Below 640px: smaller constraint */
  @media (max-width: 640px) {
    max-width: min(
      400px,
      calc(100vw - 80px)
    ) !important; /* Account for padding */
  }

  /* Below 480px: mobile constraint */
  @media (max-width: 480px) {
    max-width: min(
      300px,
      calc(100vw - 60px)
    ) !important; /* Account for padding */
  }

  /* Fallback for browsers that don't support aspect-ratio */
  @supports not (aspect-ratio: 16 / 9) {
    height: 400px;

    @media (max-width: 1023px) {
      height: calc(min(560px, 100vw - 120px) * 9 / 16);
    }

    @media (max-width: 640px) {
      height: calc(min(400px, 100vw - 80px) * 9 / 16);
    }

    @media (max-width: 480px) {
      height: calc(min(300px, 100vw - 60px) * 9 / 16);
    }
  }
}

/* YouTube facade-specific styles */
.youtube-facade {
  cursor: pointer;
  transition: transform $duration-200 ease;

  &:hover {
    transform: scale(1.02);
  }

  /* Thumbnail loading optimization */
  img {
    will-change: auto;
    backface-visibility: hidden;
  }
}

/* === RESPONSIVE IMAGES AND STICKERS === */
.message-image {
  max-width: 300px; // Desktop: standard max width
  width: 100%; // Take full width of available parent container
  height: auto;
  /* No max-height constraint - allow natural height based on aspect ratio */

  // On narrow screens: ensure images never exceed container width
  @media (max-width: $screen-xs) { // 480px and below
    max-width: 100%; // Override 300px limit, use container width
  }

  /* Add top margin below 640px to avoid 3-dots overlap */
  @media (max-width: 640px) {
    margin-top: $s-3; /* 12px top margin for spacing */
  }
}

.message-sticker {
  max-width: 300px; // Desktop: standard max width
  max-height: 600px;
  width: 100%; // Take full width of available parent container
  height: auto;
  object-fit: contain; /* Ensure image fits within bounds while maintaining aspect ratio */

  // On narrow screens: ensure stickers never exceed container width
  @media (max-width: $screen-xs) { // 480px and below
    max-width: 100%; // Override 300px limit, use container width
  }

  /* Add top margin below 640px to avoid 3-dots overlap */
  @media (max-width: 640px) {
    margin-top: $s-3; /* 12px top margin for spacing */
  }
}

/* === MESSAGE EDIT UI === */
.message-edit-container {
  margin-top: $s-2;
  padding: $s-3;
  background-color: rgb(var(--surface-2));
  border-radius: $rounded-md;
  border: 1px solid rgb(var(--surface-4));
}

.message-edit-textarea {
  width: 100%;
  min-height: 60px;
  max-height: 200px;
  padding: $s-2;
  background-color: var(--color-field-bg);
  border: 1px solid var(--color-field-border);
  border-radius: $rounded-md;
  color: var(--color-field-text);
  font-family: inherit;
  font-size: inherit;
  resize: none;
  outline: none;
  transition: all $duration-150 $ease-in-out;

  &::placeholder {
    color: var(--color-field-placeholder);
  }

  &:hover:not(:focus) {
    background-color: var(--color-field-bg-focus);
    border-color: var(--color-field-border-hover);
  }

  &:focus {
    border-color: var(--color-field-border-focus);
    background-color: var(--color-field-bg-focus);
    box-shadow: 0 0 0 $s-1 var(--color-field-focus-shadow);
  }
}

.message-edit-actions {
  margin-top: $s-2;
}

.message-edit-cancel-button,
.message-edit-save-button {
  padding: $s-1 $s-3;
  border-radius: $rounded-sm;
  border: none;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all $duration-200 ease;

  &:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
}

.message-edit-cancel-button {
  background-color: rgb(var(--surface-3));
  color: rgb(var(--text-main));

  &:hover:not(:disabled) {
    background-color: rgb(var(--surface-4));
  }
}

.message-edit-save-button {
  background-color: rgb(var(--primary));
  color: rgb(var(--text-on-primary));

  &:hover:not(:disabled) {
    background-color: rgb(var(--primary-hover));
  }
}

/* Username truncation now handled by centralized .truncate-user-name class in _base.scss */

/* === INLINE CODE STYLING === */
/* Inline code (not inside pre blocks) gets pill/badge styling */
/* Code inside pre blocks inherits from pre with no extra styling */
.markdown-code:not(pre .markdown-code) {
  background-color: var(--surface-4);
  border: $border solid var(--border-default);
  padding: $s-0-5 $s-1-5;
  border-radius: $rounded;
  font-size: $text-xs;
  font-family: monospace;
  margin-left: $s-0-5;
  margin-right: $s-0-5;
  color: var(--accent-500);
}

/* === MOBILE TIMESTAMP ALIGNMENT === */
/* Remove left margin from timestamp on mobile when it's above username */
@media (max-width: $screen-xs) {
  .message-timestamp {
    margin-left: 0 !important;
  }
}

/* === MESSAGE SEND STATUS INDICATOR === */
.message-status {
  font-size: $text-sm;

  &.sending {
    color: rgb(var(--warning));
    // Only show after 1s delay - avoids flicker for fast sends
    opacity: 0;
    animation: fadeInSending 0.2s ease-in forwards;
    animation-delay: 1s;
  }

  &.failed {
    color: rgb(var(--danger));
  }

  &__retry {
    text-decoration: underline;
    cursor: pointer;

    &:hover {
      opacity: 0.8;
    }
  }
}

@keyframes fadeInSending {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

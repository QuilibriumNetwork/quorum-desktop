%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4f46e5', 'primaryTextColor': '#fff', 'primaryBorderColor': '#4338ca', 'lineColor': '#6366f1', 'secondaryColor': '#f0fdf4', 'tertiaryColor': '#fef3c7', 'fontSize': '14px'}}}%%
flowchart TD
    subgraph LOGIN["üè† LOGIN SCREEN"]
        START((" "))
        NEW[["Create New Account"]]
        IMPORT[["Import Existing Key"]]
    end

    subgraph IMPORT_FILE["üìÅ FILE IMPORT"]
        DROP["Drop .key file"]
        VALIDATE{{"Valid?"}}
        PARSE["Parse private key<br/>from file"]
    end

    subgraph KEYGEN["üîë KEY GENERATION"]
        GEN["Generate new<br/>Ed448 keypair"]
    end

    subgraph PASSKEY_FLOW["üîê PASSKEY CREATION (2 Steps Required)"]
        direction TB

        subgraph STEP1["Step 1: Create Credential"]
            MSG1["'Two round-trips required...'"]
            BTN1[["Continue"]]
            AUTH1["üîí Biometric/PIN #1"]
            CRED["Credential Created"]
        end

        subgraph STEP2["Step 2: Store Key"]
            MSG2["'One more interaction...'"]
            BTN2[["Continue"]]
            AUTH2["üîí Biometric/PIN #2"]
            STORE["Private Key Stored"]
        end
    end

    subgraph ERROR_HANDLING["‚ö†Ô∏è ERROR / FALLBACK"]
        ERR["Passkey Failed"]
        ERRMSG["Browser/authenticator<br/>not supported"]
        FALLBACK[["Proceed Without Passkeys"]]
        CANCEL[["Cancel"]]
        INDEXDB["Store in IndexedDB<br/>(less secure)"]
    end

    subgraph ONBOARDING["üìù ONBOARDING"]
        BACKUP["1. Key Backup"]
        NAME["2. Display Name"]
        PHOTO["3. Profile Photo"]
        DONE["4. Complete"]
    end

    APP(("‚úÖ APP<br/>READY"))
    BACK(("‚Ü©Ô∏è Back"))

    START --> NEW
    START --> IMPORT

    NEW --> GEN
    IMPORT --> DROP
    DROP --> VALIDATE
    VALIDATE -->|"‚ùå Invalid"| DROP
    VALIDATE -->|"‚úì Valid"| PARSE

    GEN --> MSG1
    PARSE --> MSG1

    MSG1 --> BTN1
    BTN1 --> AUTH1
    AUTH1 -->|"‚úì Success"| CRED
    AUTH1 -->|"‚ùå Failed"| ERR

    CRED --> MSG2
    MSG2 --> BTN2
    BTN2 --> AUTH2
    AUTH2 -->|"‚úì Success"| STORE
    AUTH2 -->|"‚ùå Failed"| ERR

    ERR --> ERRMSG
    ERRMSG --> FALLBACK
    ERRMSG --> CANCEL
    FALLBACK --> INDEXDB
    CANCEL --> BACK

    STORE --> BACKUP
    INDEXDB --> BACKUP

    BACKUP --> NAME
    NAME --> PHOTO
    PHOTO --> DONE
    DONE --> APP

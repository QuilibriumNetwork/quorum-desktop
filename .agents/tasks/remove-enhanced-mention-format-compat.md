---
type: task
title: "Remove Deprecated Enhanced Mention Format Backward Compatibility Code"
status: pending
complexity: low
ai_generated: true
reviewed_by: null
created: 2026-01-09
updated: 2026-01-09
related_docs: ["mention-notification-system.md", "markdown-renderer.md"]
---

# Remove Deprecated Enhanced Mention Format Backward Compatibility Code

> **⚠️ AI-Generated**: May contain errors. Verify before use.

**Files**:
- `src/components/message/MessageMarkdownRenderer.tsx:327-356`
- `src/components/message/MessageMarkdownRenderer.tsx:422-456`
- `src/components/message/Message.tsx:944`
- `src/utils/mentionHighlighting.ts:104`
- `src/utils/mentionHighlighting.ts:145`

## What & Why

The codebase currently parses deprecated enhanced mention formats (`@[Display Name]<address>` and `#[Channel Name]<channelId>`) for backward compatibility, but these formats are no longer generated by the system. Since the app is in beta and there are minimal old messages, we can safely remove this backward compatibility code to simplify the codebase. The system only supports and generates simple formats: `@<address>` and `#<channelId>`.

## Context

- **Current behavior**: System accepts both formats but ignores embedded display names for security (always does lookups)
- **Desired behavior**: System only accepts simple formats, simplifying regex patterns
- **Timing**: Safe to remove now since app is in beta with minimal message history
- **Alternative**: Could wait 3-6 months for more message history to age out, but unnecessary given beta status

---

## Implementation

1. **Simplify user mention regex in MessageMarkdownRenderer** (`src/components/message/MessageMarkdownRenderer.tsx:327`)
   ```typescript
   // Current (line 327):
   const userMentionRegex = new RegExp(`@(?:\\[([^\\]]+)\\])?<(${cidPattern})>`, 'g');

   // Change to:
   const userMentionRegex = new RegExp(`@<(${cidPattern})>`, 'g');
   ```
   - Remove optional display name group `(?:\\[([^\\]]+)\\])?`
   - Update match array indices: `match[1]` becomes address (was `match[2]`)

2. **Remove inlineDisplayName extraction and processing** (`src/components/message/MessageMarkdownRenderer.tsx:350-356`)
   ```typescript
   // Current (lines 350-356):
   const inlineDisplayName = match[1]; // Optional display name from @[Name]<address>
   const address = match[2]; // Address is now in match[2] due to optional group
   const sanitizedDisplayName = sanitizeDisplayName(inlineDisplayName);
   processedText = beforeText + `<<<MENTION_USER:${address}:${sanitizedDisplayName}>>>` + afterText;

   // Change to:
   const address = match[1]; // Address is now in match[1]
   processedText = beforeText + `<<<MENTION_USER:${address}>>>` + afterText;
   ```
   - Remove `inlineDisplayName` extraction
   - Remove `sanitizedDisplayName` computation
   - Simplify token to not include display name placeholder

3. **Simplify channel mention regex in MessageMarkdownRenderer** (`src/components/message/MessageMarkdownRenderer.tsx:433`)
   ```typescript
   // Current (line 433):
   const channelRegex = new RegExp(`#(?:\\[([^\\]]+)\\])?<${escapedChannelId}>`, 'g');

   // Change to:
   const channelRegex = new RegExp(`#<${escapedChannelId}>`, 'g');
   ```

4. **Remove channel inlineDisplayName processing** (`src/components/message/MessageMarkdownRenderer.tsx:447-452`)
   ```typescript
   // Current (lines 447-452):
   const inlineDisplayName = match[1]; // Optional display name
   const sanitizedDisplayName = sanitizeDisplayName(inlineDisplayName);
   processed = beforeText + `<<<MENTION_CHANNEL:${channelId}:${channelName}:${sanitizedDisplayName}>>>` + afterText;

   // Change to:
   processed = beforeText + `<<<MENTION_CHANNEL:${channelId}:${channelName}>>>` + afterText;
   ```

5. **Simplify fallback tokenization regex in Message.tsx** (`src/components/message/Message.tsx:944`)
   ```typescript
   // Current (line 944):
   const mentionPattern = /(@(?:\[[^\]]+\])?<[^>]+>|#(?:\[[^\]]+\])?<[^>]+>)/g;

   // Change to:
   const mentionPattern = /(@<[^>]+>|#<[^>]+>)/g;
   ```

6. **Simplify mention highlighting regexes** (`src/utils/mentionHighlighting.ts:104,145`)
   ```typescript
   // Current (line 104):
   const userMentionRegex = /@(?:\[([^\]]+)\])?<([^>]+)>/g;

   // Change to:
   const userMentionRegex = /@<([^>]+)>/g;

   // Current (line 145):
   const channelMentionRegex = /#(?:\[([^\]]+)\])?<([^>]+)>/g;

   // Change to:
   const channelMentionRegex = /#<([^>]+)>/g;
   ```
   - Update capture group indices: `match[2]` becomes `match[1]` in both patterns

7. **Update token regex pattern in processMentionTokens** (`src/components/message/MessageMarkdownRenderer.tsx:604-607`)
   - Update regex to match simplified token format without display name placeholders
   - Update capture group indices in rendering logic (lines 628-678)
   - Verify token pattern matches new simplified format

8. **Consider removing sanitizeDisplayName callback** (`src/components/message/MessageMarkdownRenderer.tsx:280-289`)
   - Only needed if still used elsewhere
   - Check for other usages before removal
   - If unused, remove the entire callback definition

---

## Verification

✓ **TypeScript compiles**
  - Run: `npx tsc --noEmit --jsx react-jsx --skipLibCheck`
  - Expect: Zero errors

✓ **User mentions render correctly**
  - Test: Send message with `@<address>` → displays with looked-up name
  - Test: Old messages with `@[Name]<address>` → render as plain text (acceptable)

✓ **Channel mentions render correctly**
  - Test: Send message with `#<channelId>` → displays as clickable channel name
  - Test: Old messages with `#[Name]<channelId>` → render as plain text (acceptable)

✓ **Mention highlighting works in composer**
  - Test: Type `@<address>` in composer → highlights correctly
  - Test: Type `#<channelId>` → highlights correctly

✓ **No console errors**
  - Test: View channel with various mention types
  - Verify: No regex or rendering errors in console

---

## Edge Cases

| Scenario | Expected Behavior | Status | Priority | Risk |
|----------|-------------------|--------|----------|------|
| Old messages with enhanced format | Render as plain text (not as mentions) | ⚠️ Acceptable | P2 | Low |
| Composer highlighting with old format | No highlighting (acceptable) | ⚠️ Acceptable | P2 | Low |
| Fallback rendering with old format | Plain text (not styled) | ⚠️ Acceptable | P2 | Low |
| New messages with simple format | Work exactly as before | ✓ Already works | P0 | Low |

---

## Risks & Rollback

**If old messages break unexpectedly:**
- Deployment is beta, so acceptable trade-off
- Users can be informed that old mention formats are deprecated
- No data loss - messages still exist, just render as plain text

**If regex changes cause runtime errors:**
- Revert commits immediately
- All changes are in isolated regex patterns, easy to revert
- Test regex patterns individually before deployment

**If TypeScript compilation fails:**
- Update capture group indices in all pattern matches
- Check for missed usages of `inlineDisplayName` variables
- Verify token regex patterns match new format

---

## Definition of Done

- [ ] All regex patterns updated to simple format
- [ ] All capture group indices updated
- [ ] TypeScript compiles without errors
- [ ] Manual test: new mentions work correctly
- [ ] Manual test: old mentions render as plain text (acceptable)
- [ ] No console errors in development
- [ ] Code follows existing patterns in codebase

---

## Implementation Notes

_Updated during implementation_

---

## Updates

**2026-01-09 - Claude**: Initial task creation

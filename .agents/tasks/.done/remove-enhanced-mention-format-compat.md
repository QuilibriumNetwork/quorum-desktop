---
type: task
title: "Remove Deprecated Enhanced Mention Format Backward Compatibility Code"
status: completed
complexity: low
ai_generated: true
reviewed_by: null
created: 2026-01-09
updated: 2026-02-10
related_docs: ["mention-notification-system.md", "markdown-renderer.md"]
---

# Remove Deprecated Enhanced Mention Format Backward Compatibility Code

> **⚠️ AI-Generated**: May contain errors. Verify before use.

**Files**:
- `src/components/message/MessageMarkdownRenderer.tsx:280-289` (sanitizeDisplayName)
- `src/components/message/MessageMarkdownRenderer.tsx:327-360` (processMentions — user regex + inlineDisplayName)
- `src/components/message/MessageMarkdownRenderer.tsx:422-457` (processChannelMentions — channel regex + inlineDisplayName)
- `src/components/message/MessageMarkdownRenderer.tsx:584-611` (processMentionTokens — token regex with capture groups)
- `src/components/message/MessageMarkdownRenderer.tsx:628-678` (token rendering logic with group indices)
- `src/components/message/Message.tsx:932` (fallback tokenization mentionPattern)
- `src/utils/mentionHighlighting.ts:104` (user mention regex)
- `src/utils/mentionHighlighting.ts:145` (channel mention regex)

## What & Why

The codebase currently parses deprecated enhanced mention formats (`@[Display Name]<address>` and `#[Channel Name]<channelId>`) for backward compatibility, but these formats are no longer generated by the system. Since the app is in beta and there are minimal old messages, we can safely remove this backward compatibility code to simplify the codebase. The system only supports and generates simple formats: `@<address>` and `#<channelId>`.

## Context

- **Current behavior**: System accepts both formats but ignores embedded display names for security (always does lookups)
- **Desired behavior**: System only accepts simple formats, simplifying regex patterns
- **Timing**: Safe to remove now since app is in beta with minimal message history
- **Alternative**: Could wait 3-6 months for more message history to age out, but unnecessary given beta status

---

## Implementation

1. **Simplify user mention regex in MessageMarkdownRenderer** (`src/components/message/MessageMarkdownRenderer.tsx:327`)
   ```typescript
   // Current (line 327):
   const userMentionRegex = new RegExp(`@(?:\\[([^\\]]+)\\])?<(${cidPattern})>`, 'g');

   // Change to:
   const userMentionRegex = new RegExp(`@<(${cidPattern})>`, 'g');
   ```
   - Remove optional display name group `(?:\\[([^\\]]+)\\])?`
   - Update match array indices: `match[1]` becomes address (was `match[2]`)

2. **Remove inlineDisplayName extraction and processing** (`src/components/message/MessageMarkdownRenderer.tsx:350-356`)
   ```typescript
   // Current (lines 350-356):
   const inlineDisplayName = match[1]; // Optional display name from @[Name]<address>
   const address = match[2]; // Address is now in match[2] due to optional group
   const sanitizedDisplayName = sanitizeDisplayName(inlineDisplayName);
   processedText = beforeText + `<<<MENTION_USER:${address}:${sanitizedDisplayName}>>>` + afterText;

   // Change to:
   const address = match[1]; // Address is now in match[1]
   processedText = beforeText + `<<<MENTION_USER:${address}>>>` + afterText;
   ```
   - Remove `inlineDisplayName` extraction
   - Remove `sanitizedDisplayName` computation
   - Simplify token to not include display name placeholder

3. **Simplify channel mention regex in MessageMarkdownRenderer** (`src/components/message/MessageMarkdownRenderer.tsx:433`)
   ```typescript
   // Current (line 433):
   const channelRegex = new RegExp(`#(?:\\[([^\\]]+)\\])?<${escapedChannelId}>`, 'g');

   // Change to:
   const channelRegex = new RegExp(`#<${escapedChannelId}>`, 'g');
   ```

4. **Remove channel inlineDisplayName processing** (`src/components/message/MessageMarkdownRenderer.tsx:447-452`)
   ```typescript
   // Current (lines 447-452):
   const inlineDisplayName = match[1]; // Optional display name
   const sanitizedDisplayName = sanitizeDisplayName(inlineDisplayName);
   processed = beforeText + `<<<MENTION_CHANNEL:${channelId}:${channelName}:${sanitizedDisplayName}>>>` + afterText;

   // Change to:
   processed = beforeText + `<<<MENTION_CHANNEL:${channelId}:${channelName}>>>` + afterText;
   ```

5. **Simplify fallback tokenization regex in Message.tsx** (`src/components/message/Message.tsx:932`)
   ```typescript
   // Current (line 932):
   const mentionPattern = /(@(?:\[[^\]]+\])?<[^>]+>|#(?:\[[^\]]+\])?<[^>]+>)/g;

   // Change to:
   const mentionPattern = /(@<[^>]+>|#<[^>]+>)/g;
   ```
   - Also update the comment on lines 930-931 to remove references to `@[Display Name]<address>` format

6. **Simplify mention highlighting regexes** (`src/utils/mentionHighlighting.ts:104,145`)
   ```typescript
   // Current (line 104):
   const userMentionRegex = /@(?:\[([^\]]+)\])?<([^>]+)>/g;

   // Change to:
   const userMentionRegex = /@<([^>]+)>/g;

   // Current (line 145):
   const channelMentionRegex = /#(?:\[([^\]]+)\])?<([^>]+)>/g;

   // Change to:
   const channelMentionRegex = /#<([^>]+)>/g;
   ```
   - Update capture group indices: `match[2]` becomes `match[1]` in both patterns

7. **Update token regex pattern in processMentionTokens** (`src/components/message/MessageMarkdownRenderer.tsx:604-611`)

   The combined token regex currently has 13 capture groups. Removing the inline display name groups (match[4] for USER and match[9] for CHANNEL) shifts all subsequent indices.

   ```typescript
   // Current token regex (lines 604-611):
   `<<<(` +
     `MENTION_(EVERYONE|USER:(${cidPattern}):([^>]{0,200})|ROLE:([^:]{1,50}):([^>]{1,200})|CHANNEL:([^:>]{1,50}):([^:>]{1,200}):([^>]{0,200}))|` +
     `MESSAGE_LINK:([^:>]{1,100}):([^:>]{1,100}):([^>]{0,200})` +
   `)>>>|` +
   `\\|\\|([^|]{1,500})\\|\\|`

   // Change to (remove :([^>]{0,200}) from USER and :([^>]{0,200}) from CHANNEL):
   `<<<(` +
     `MENTION_(EVERYONE|USER:(${cidPattern})|ROLE:([^:]{1,50}):([^>]{1,200})|CHANNEL:([^:>]{1,50}):([^:>]{1,200}))|` +
     `MESSAGE_LINK:([^:>]{1,100}):([^:>]{1,100}):([^>]{0,200})` +
   `)>>>|` +
   `\\|\\|([^|]{1,500})\\|\\|`
   ```

   **Capture group re-mapping (old → new):**

   | Purpose | Old Group | New Group |
   |---------|-----------|-----------|
   | Full token content | match[1] | match[1] |
   | MENTION subtype | match[2] | match[2] |
   | USER address | match[3] | match[3] |
   | ~~USER inlineDisplayName~~ | ~~match[4]~~ | _removed_ |
   | ROLE roleTag | match[5] | match[4] |
   | ROLE displayName | match[6] | match[5] |
   | CHANNEL channelId | match[7] | match[6] |
   | CHANNEL channelName | match[8] | match[7] |
   | ~~CHANNEL inlineDisplayName~~ | ~~match[9]~~ | _removed_ |
   | MESSAGE_LINK channelId | match[10] | match[8] |
   | MESSAGE_LINK messageId | match[11] | match[9] |
   | MESSAGE_LINK channelName | match[12] | match[10] |
   | SPOILER content | match[13] | match[11] |

   **Update rendering logic (lines 628-678+):**
   - Line 628: `match[3]` → stays `match[3]` (USER address — unchanged)
   - Line 631: Remove comment about match[4] inline display name
   - Line 652: `match[5] && match[6]` → `match[4] && match[5]` (ROLE)
   - Line 654-655: `match[5]`/`match[6]` → `match[4]`/`match[5]` (ROLE tag/name)
   - Line 665: `match[7] && match[8]` → `match[6] && match[7]` (CHANNEL)
   - Line 667-668: `match[7]`/`match[8]` → `match[6]`/`match[7]` (CHANNEL id/name)
   - Line 669: Remove comment about match[9] inline display name
   - Line 679: `match[10] && match[11] && match[12]` → `match[8] && match[9] && match[10]` (MESSAGE_LINK)
   - Lines 681-683: `match[10]`/`match[11]`/`match[12]` → `match[8]`/`match[9]`/`match[10]`
   - Spoiler match: `match[13]` → `match[11]`

   **Update comment block (lines 588-601)** to reflect new group mapping.

8. **Remove sanitizeDisplayName callback** (`src/components/message/MessageMarkdownRenderer.tsx:280-289`)
   - After steps 2 and 4, `sanitizeDisplayName` has no remaining callers
   - It is only referenced in `processMentions` (line 360) and `processChannelMentions` (line 457) dependency arrays — both of which will be updated
   - Remove the entire callback definition (lines 280-289)
   - Remove from dependency arrays of `processMentions` and `processChannelMentions`

9. **Update comments referencing deprecated format**
   - `MessageMarkdownRenderer.tsx:323` — remove `OR @[Display Name]<address>` from comment
   - `MessageMarkdownRenderer.tsx:432` — remove `and #[Channel Name]<channelId>` from comment
   - `Message.tsx:930-931` — remove `@[Display Name]<address>` / `#[Channel Name]<channelId>` references
   - `mentionHighlighting.ts:103` — remove `and @[Name]<address> (both formats)` from comment
   - `mentionHighlighting.ts:144` — remove `and #[Name]<id> (both formats)` from comment

---

## Verification

✓ **TypeScript compiles**
  - Run: `npx tsc --noEmit --jsx react-jsx --skipLibCheck`
  - Expect: Zero errors

✓ **User mentions render correctly**
  - Test: Send message with `@<address>` → displays with looked-up name
  - Test: Old messages with `@[Name]<address>` → render as plain text (acceptable)

✓ **Channel mentions render correctly**
  - Test: Send message with `#<channelId>` → displays as clickable channel name
  - Test: Old messages with `#[Name]<channelId>` → render as plain text (acceptable)

✓ **Mention highlighting works in composer**
  - Test: Type `@<address>` in composer → highlights correctly
  - Test: Type `#<channelId>` → highlights correctly

✓ **No console errors**
  - Test: View channel with various mention types
  - Verify: No regex or rendering errors in console

---

## Edge Cases

| Scenario | Expected Behavior | Status | Priority | Risk |
|----------|-------------------|--------|----------|------|
| Old messages with enhanced format | Render as plain text (not as mentions) | ⚠️ Acceptable | P2 | Low |
| Composer highlighting with old format | No highlighting (acceptable) | ⚠️ Acceptable | P2 | Low |
| Fallback rendering with old format | Plain text (not styled) | ⚠️ Acceptable | P2 | Low |
| New messages with simple format | Work exactly as before | ✓ Already works | P0 | Low |

---

## Risks & Rollback

**If old messages break unexpectedly:**
- Deployment is beta, so acceptable trade-off
- Users can be informed that old mention formats are deprecated
- No data loss - messages still exist, just render as plain text

**If regex changes cause runtime errors:**
- Revert commits immediately
- All changes are in isolated regex patterns, easy to revert
- Test regex patterns individually before deployment

**If TypeScript compilation fails:**
- Update capture group indices in all pattern matches
- Check for missed usages of `inlineDisplayName` variables
- Verify token regex patterns match new format

---

## Definition of Done

- [ ] All regex patterns updated to simple format
- [ ] All capture group indices updated
- [ ] TypeScript compiles without errors
- [ ] Manual test: new mentions work correctly
- [ ] Manual test: old mentions render as plain text (acceptable)
- [ ] No console errors in development
- [ ] Code follows existing patterns in codebase

---

## Implementation Notes

_Updated during implementation_

---

## Updates

**2026-02-10 - Claude**: Pre-implementation verification and task update
- Verified all referenced code still exists in codebase
- Corrected `Message.tsx` line reference from 944 → 932
- Expanded file list to include all affected areas (280-289, 584-611, 628-678)
- Fully detailed Step 7 with complete capture group re-mapping table (13 → 11 groups)
- Clarified Step 8: `sanitizeDisplayName` can be fully removed (no other callers)
- Added Step 9: update comments referencing deprecated format

**2026-01-09 - Claude**: Initial task creation

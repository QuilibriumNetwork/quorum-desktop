# Fix Read-Only Channel Bypass Vulnerability

> **âš ï¸ AI-Generated**: May contain errors. Verify before use.
> **Reviewed by**: security-analyst agent, feature-analyzer agent

**Status**: Completed
**Complexity**: High
**Priority**: URGENT - Security
**Created**: 2025-12-11
**Files**:
- `src/utils/channelPermissions.ts:98-113`
- `src/services/MessageService.ts:820-850`
- `src/components/space/ChannelEditorModal.tsx` (tooltip update)

## What & Why

**Current state**: Read-only channels can be bypassed by custom clients. The UI prevents posting, but there is NO receiving-side validation - unauthorized messages are displayed to ALL official client users.

**Desired state**: Both sending (UI) and receiving sides enforce read-only channel restrictions consistently, using manager role membership as the only authorization check.

**Value**: Closes a HIGH-risk security vulnerability that undermines space moderation capabilities. Prevents malicious users from spamming read-only announcement channels.

## Context

- **Related audit**: [Client-Side Limitations Bypass Audit](.temp/client-side-limitations-bypass-audit_2025-12-11.md)
- **Existing pattern**: Delete message validation in MessageService.ts lines 691-750
- **Privacy constraint**: Cannot use `Space.ownerAddress` field (would reveal space owner identity)
- **Design decision**: Space owners must explicitly join a manager role to post in read-only channels

## Prerequisites

- [x] Security audit completed and reviewed
- [x] Solution validated by security-analyst agent
- [x] Privacy implications understood (no Space.ownerAddress)
- [ ] Branch created from `develop`

## Implementation

### Part A: Remove Space Owner Implicit Permission (UI)

- [x] **Update `canPostMessage()` in channelPermissions.ts** (`src/utils/channelPermissions.ts:98-113`)

  **Current code**:
  ```typescript
  canPostMessage(): boolean {
    const { isSpaceOwner, channel } = this.context;
    if (isSpaceOwner) {
      return true;  // â† REMOVE THIS
    }
    if (channel?.isReadOnly) {
      return this.isReadOnlyChannelManager();
    }
    return true;
  }
  ```

  **Change to**:
  ```typescript
  canPostMessage(): boolean {
    const { channel } = this.context;
    if (channel?.isReadOnly) {
      return this.isReadOnlyChannelManager();
    }
    return true;
  }
  ```

  - Done when: `canPostMessage()` no longer has early return for space owners
  - Verify: Space owner without manager role sees disabled message composer in read-only channel

### Part B: Add Receiving-Side Validation

- [x] **Add read-only channel validation in MessageService.ts** (`src/services/MessageService.ts`)

  Location: Inside the final `else` block, BEFORE `queryClient.setQueryData`

  **Add this validation** (updated based on security-analyst review):
  ```typescript
  } else {
    // Read-only channel validation - must validate BEFORE adding to cache

    // Skip validation for DMs (spaceId === channelId indicates direct message)
    const isDM = spaceId === channelId;
    const isValidatableType =
      decryptedContent.content.type === 'post' ||
      decryptedContent.content.type === 'edit-message';

    if (!isDM && isValidatableType) {
      // Fetch space data for validation
      const space = await this.messageDB.getSpace(spaceId);

      // FAIL-SECURE: Reject if space data unavailable
      if (!space) {
        console.warn(`âš ï¸ Rejecting message ${decryptedContent.messageId} - space ${spaceId} data unavailable`);
        return;
      }

      // Find the target channel in space groups
      const channel = space.groups
        ?.find((g) => g.channels.find((c) => c.channelId === channelId))
        ?.channels.find((c) => c.channelId === channelId);

      // FAIL-SECURE: Reject if channel not found
      if (!channel) {
        console.warn(`âš ï¸ Rejecting message ${decryptedContent.messageId} - channel ${channelId} not found in space ${spaceId}`);
        return;
      }

      // Validate read-only channel permissions
      if (channel.isReadOnly) {
        const senderId = decryptedContent.content.senderId;

        // Check if channel has manager roles configured
        if (!channel.managerRoleIds || channel.managerRoleIds.length === 0) {
          console.log(`ðŸ”’ Rejecting message ${decryptedContent.messageId} from ${senderId} - read-only channel ${channelId} has no manager roles configured`);
          return;
        }

        // Check if sender is in a manager role
        // Note: Space owners must explicitly join a manager role (privacy requirement)
        const isChannelManager = space.roles?.some(
          (role) =>
            channel.managerRoleIds.includes(role.roleId) &&
            role.members?.includes(senderId)
        ) ?? false;

        if (!isChannelManager) {
          console.log(`ðŸ”’ Rejecting unauthorized message ${decryptedContent.messageId} from ${senderId} in read-only channel ${channelId}`);
          return;
        }
      }
    }

    // Authorized - continue with existing code
    queryClient.setQueryData(...);
  }
  ```

  **Key security improvements** (from security-analyst review):
  - âœ… **Fail-secure**: Rejects messages when space/channel data unavailable
  - âœ… **Edit-message validation**: Also validates `edit-message` type, not just `post`
  - âœ… **Explicit logic**: Removed `!!` pattern for clearer validation
  - âœ… **Comprehensive logging**: Includes messageId for audit trail

  - Done when: Unauthorized messages/edits to read-only channels are dropped
  - Verify: Message from non-manager sent via custom client does NOT appear in channel

### Part C: Update Channel Manager Tooltip (UX)

- [x] **Improve "Channel Managers" tooltip in ChannelEditorModal**

  The current tooltip may not clearly communicate that **space owners must also assign themselves** to a manager role to post in read-only channels.

  - Location: `src/components/space/ChannelEditorModal.tsx` (find the Channel Managers tooltip)
  - Update tooltip text to clarify:
    - Selected roles can post/delete/pin in this read-only channel
    - **Space owners must also add themselves to a manager role** to post here

  Example updated tooltip:
  > "Members of selected roles can post, delete, and pin messages in this read-only channel. Note: Space owners must also be in a manager role to post here."

  - Done when: Tooltip clearly explains that space owners need explicit manager role assignment
  - Verify: Tooltip displays updated text when hovering over info icon

## Verification

âœ… **UI blocks space owner without manager role**
   - Test: As space owner (not in manager role), navigate to read-only channel
   - Expected: Message composer is disabled/hidden

âœ… **UI allows space owner WITH manager role**
   - Test: As space owner, add yourself to a manager role, navigate to read-only channel
   - Expected: Message composer is enabled, can post

âœ… **Receiving validation rejects unauthorized posts**
   - Test: Simulate receiving a message from non-manager address to read-only channel
   - Expected: Message is dropped, does not appear in channel

âœ… **Receiving validation allows manager posts**
   - Test: Simulate receiving a message from manager address to read-only channel
   - Expected: Message appears in channel normally

âœ… **DMs are not affected**
   - Test: Send/receive direct messages
   - Expected: DMs work normally (spaceId === channelId bypasses validation)

âœ… **TypeScript compiles**
   - Run: `npx tsc --noEmit`

âœ… **No console errors**
   - Test: Normal usage of read-only channels with authorized users

### Additional Security Tests (from security-analyst review)

âœ… **Fail-secure: Missing space data**
   - Test: Simulate receiving message when space data is unavailable
   - Expected: Message rejected with warning in console

âœ… **Fail-secure: Missing channel data**
   - Test: Simulate receiving message for non-existent channel
   - Expected: Message rejected with warning in console

âœ… **Edit message validation: Unauthorized edit**
   - Test: Non-manager tries to edit message in read-only channel
   - Expected: Edit rejected, original message unchanged

âœ… **Edit message validation: Authorized edit**
   - Test: Manager edits message in read-only channel
   - Expected: Edit applied successfully

âœ… **Empty manager roles array**
   - Test: Read-only channel with `managerRoleIds = []`
   - Expected: All posts rejected (nobody can post)

âœ… **No manager roles configured (undefined)**
   - Test: Read-only channel without `managerRoleIds` field
   - Expected: All posts rejected

## Technical Notes

### Why No Space Owner Check on Receive?

The receiving side cannot check `isSpaceOwner` because:
1. `Space` object doesn't have an `ownerAddress` field
2. Adding `Space.ownerAddress` would reveal space owner identity (privacy concern)
3. Therefore, space owners must explicitly add themselves to a manager role

This is a deliberate design decision to preserve privacy.

### Pattern Reference

This follows the same pattern as delete message validation (lines 691-750):
- Fetch space data
- Find channel in space.groups
- Check role membership
- Silently drop unauthorized actions

### Known Limitation: TOCTOU Race Condition

A theoretical Time-of-Check-Time-of-Use (TOCTOU) vulnerability exists where space configuration could change between fetching data and using it for validation. This is **acceptable risk** for a decentralized system because:
- Space updates propagate relatively slowly in decentralized systems
- The timing window is extremely narrow (microseconds)
- Perfect consistency is impossible without distributed locking
- Eventual consistency is expected in decentralized architecture

## Definition of Done

- [x] Part A: Space owner implicit permission removed from UI
- [x] Part B: Receiving-side validation added to MessageService.ts
- [x] Part C: Channel Manager tooltip updated in ChannelEditorModal
- [ ] All basic verification tests pass
- [ ] All security tests pass (fail-secure, edit-message, empty roles)
- [x] TypeScript compiles without errors
- [ ] No console errors during normal usage
- [ ] Manual testing confirms fix works as expected

## Related Documentation

- [Client-Side Limitations Bypass Audit](../reports/client-side-limitations-bypass-audit_2025-12-11.md)
- [Read-Only Channels System](../docs/space-permissions/read-only-channels-system.md)
- [Space Permissions Architecture](../docs/space-permissions/space-permissions-architecture.md)

---

_Created: 2025-12-11_
